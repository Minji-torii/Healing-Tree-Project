<html><head>
<TITLE>Dynamic clouds</TITLE>
<style type="text/css">
  H1{ font-size: 120%; color: green}
  pre{ color: darkblue}
</style>

<script id="shader-vs" type="x-shader/x-vertex"> 
  attribute vec2 aPos;
void main(void) {
   gl_Position = vec4(aPos, 0., 1.);
}
</script> 
 
<script id="shader-fs" type="x-shader/x-fragment"> 
precision highp float;
uniform sampler2D gradTexture;

void simplex( const in vec3 P, out vec3 offset1, out vec3 offset2 ){
  vec3 offset0;
  vec2 isX = step( P.yz, P.xx );
  offset0.x  = isX.x + isX.y;
  offset0.yz = 1.0 - isX;
  float isY = step( P.z, P.y );
  offset0.y += isY;
  offset0.z += 1.0 - isY;
  offset2 = clamp( offset0, 0.0, 1.0 );
  offset1 = clamp( offset0-1.0, 0.0, 1.0 );
}
float snoise(vec3 P) {
#define ONE 0.00390625
#define ONEHALF 0.001953125
#define F3 0.333333333333
#define G3 0.166666666667
  float s = (P.x + P.y + P.z) * F3;
  vec3 Pi = floor(P + s);
  float t = (Pi.x + Pi.y + Pi.z) * G3;
  vec3 P0 = Pi - t;
  Pi = Pi * ONE + ONEHALF;
  vec3 Pf0 = P - P0;
  vec3 o1;
  vec3 o2;
  simplex(Pf0, o1, o2);
  float perm0 = texture2D(gradTexture, Pi.xy).a;
  vec3  grad0 = texture2D(gradTexture, vec2(perm0, Pi.z)).rgb * 4.0 - 2.0;
  grad0.z = floor(grad0.z);
  float t0 = 0.6 - dot(Pf0, Pf0);
  float n0;
  if (t0 < 0.0) n0 = 0.0;
  else {
    t0 *= t0;
    n0 = t0 * t0 * dot(grad0, Pf0);
  }
  vec3 Pf1 = Pf0 - o1 + G3;
  float perm1 = texture2D(gradTexture, Pi.xy + o1.xy*ONE).a;
  vec3  grad1 = texture2D(gradTexture, vec2(perm1, Pi.z + o1.z*ONE)).rgb * 4.0 - 2.0;
  grad1.z = floor(grad1.z);
  float t1 = 0.6 - dot(Pf1, Pf1);
  float n1;
  if (t1 < 0.0) n1 = 0.0;
  else {
    t1 *= t1;
    n1 = t1 * t1 * dot(grad1, Pf1);
  }
  vec3 Pf2 = Pf0 - o2 + 2.0 * G3;
  float perm2 = texture2D(gradTexture, Pi.xy + o2.xy*ONE).a;
  vec3  grad2 = texture2D(gradTexture, vec2(perm2, Pi.z + o2.z*ONE)).rgb * 4.0 - 2.0;
  grad2.z = floor(grad2.z);
  float t2 = 0.6 - dot(Pf2, Pf2);
  float n2;
  if (t2 < 0.0) n2 = 0.0;
  else {
    t2 *= t2;
    n2 = t2 * t2 * dot(grad2, Pf2);
  }
  vec3 Pf3 = Pf0 - vec3(1.0-3.0*G3);
  float perm3 = texture2D(gradTexture, Pi.xy + vec2(ONE, ONE)).a;
  vec3  grad3 = texture2D(gradTexture, vec2(perm3, Pi.z + ONE)).rgb * 4.0 - 2.0;
  grad3.z = floor(grad3.z);
  float t3 = 0.6 - dot(Pf3, Pf3);
  float n3;
  if(t3 < 0.0) n3 = 0.0;
  else {
    t3 *= t3;
    n3 = t3 * t3 * dot(grad3, Pf3);
  }
  return 20.0 * (n0 + n1 + n2 + n3);
}

uniform float t;
uniform vec2 dx;
void main(void) {
   float Y = gl_FragCoord.y/dx.y;
   float c = .2;
   if(Y > .1){
     vec2 x = vec2(gl_FragCoord.x*dx.x - 1., 1.5)/Y;
     x.x += t;
     c = snoise(vec3(x, t));
     float a = .5;
     x += x;  c += a*snoise(vec3(x, t));  a *= .5;
     x += x;  c += a*snoise(vec3(x, t));  a *= .5;
     x += x;  c += a*snoise(vec3(x, t));  a *= .5;
     x += x;  c += a*snoise(vec3(x, t));  a *= .5;}
   gl_FragColor = vec4(vec2(c*min(Y+Y, 1.)), 1., 1.);
}
</script> 
 
<script type="text/javascript"> 
function getShader ( gl, id ){
   var shaderScript = document.getElementById ( id );
   var str = "";
   var k = shaderScript.firstChild;
   while ( k ){
     if ( k.nodeType == 3 ) str += k.textContent;
     k = k.nextSibling;
   }
   var shader;
   if ( shaderScript.type == "x-shader/x-fragment" )
           shader = gl.createShader ( gl.FRAGMENT_SHADER );
   else if ( shaderScript.type == "x-shader/x-vertex" )
           shader = gl.createShader(gl.VERTEX_SHADER);
   else return null;
   gl.shaderSource(shader, str);
   gl.compileShader(shader);
   if (gl.getShaderParameter(shader, gl.COMPILE_STATUS) == 0)
      alert(id + "\n" + gl.getShaderInfoLog(shader));
   return shader;
}

var gl, tLoc, ti = 0,  time, frames;
function webGLStart() {
   canvas = document.getElementById("canvas");
   if (!window.WebGLRenderingContext){
     alert("Your browser does not support WebGL. See http://get.webgl.org");
     return;}
   try { gl = canvas.getContext("experimental-webgl");
   } catch(e) {}
   if ( !gl ) {alert("Can't get WebGL"); return;}

   var h = window.innerHeight - 10;
   var w = window.innerWidth*.85;
   canvas.width =  w;   canvas.height = h;
   gl.viewport(0, 0, w, h);

   var prog  = gl.createProgram();
   gl.attachShader(prog, getShader( gl, "shader-vs" ));
   gl.attachShader(prog, getShader( gl, "shader-fs" ));
   gl.linkProgram(prog);
   gl.useProgram(prog);
   tLoc = gl.getUniformLocation(prog, "t");
   gl.uniform2f( gl.getUniformLocation(prog, "dx"), 2/w, h );

var perm = [151,160,137,91,90,15,
  131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,
  190, 6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,
  88,237,149,56,87,174,20,125,136,171,168, 68,175,74,165,71,134,139,48,27,166,
  77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,
  102,143,54, 65,25,63,161, 1,216,80,73,209,76,132,187,208, 89,18,169,200,196,
  135,130,116,188,159,86,164,100,109,198,173,186, 3,64,52,217,226,250,124,123,
  5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,
  223,183,170,213,119,248,152, 2,44,154,163, 70,221,153,101,155,167, 43,172,9,
  129,22,39,253, 19,98,108,110,79,113,224,232,178,185, 112,104,218,246,97,228,
  251,34,242,193,238,210,144,12,191,179,162,241, 81,51,145,235,249,14,239,107,
  49,192,214, 31,181,199,106,157,184, 84,204,176,115,121,50,45,127, 4,150,254,
  138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180];
  var pixels = new Uint8Array( 256*256*4 );
  var grad4 = [[0,1,1,1], [0,1,1,-1], [0,1,-1,1], [0,1,-1,-1], // 32 tesseract edges
               [0,-1,1,1], [0,-1,1,-1], [0,-1,-1,1], [0,-1,-1,-1],
               [1,0,1,1], [1,0,1,-1], [1,0,-1,1], [1,0,-1,-1],
               [-1,0,1,1], [-1,0,1,-1], [-1,0,-1,1], [-1,0,-1,-1],
               [1,1,0,1], [1,1,0,-1], [1,-1,0,1], [1,-1,0,-1],
               [-1,1,0,1], [-1,1,0,-1], [-1,-1,0,1], [-1,-1,0,-1],
               [1,1,1,0], [1,1,-1,0], [1,-1,1,0], [1,-1,-1,0],
               [-1,1,1,0], [-1,1,-1,0], [-1,-1,1,0], [-1,-1,-1,0]];
  for(var i = 0; i<256; i++)
    for(var j = 0; j<256; j++) {
      var offset = (i*256+j)*4;
      var value = perm[(j+perm[i]) & 0xFF];
      pixels[offset]   = grad4[value & 0x0F][0] * 64 + 128; // Gradient x
      pixels[offset+1] = grad4[value & 0x0F][1] * 64 + 128; // Gradient y
      pixels[offset+2] = grad4[value & 0x0F][2] * 64 + grad4[value & 0x0F][3] * 16 + 128; // Gradient z,w
      pixels[offset+3] = value;                     // Permuted index
    }
   var texture = gl.createTexture();
   gl.activeTexture(gl.TEXTURE0);
   gl.bindTexture(gl.TEXTURE_2D, texture);
   gl.pixelStorei(gl.UNPACK_ALIGNMENT, 1);
   gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 256, 256, 0,
     gl.RGBA, gl.UNSIGNED_BYTE, pixels);
   gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
   gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);

   var pt = [-1,-1, 1,-1, -1,1, 1,1];
   var posLoc = gl.getAttribLocation(prog, "aPos");
   gl.enableVertexAttribArray( posLoc );
   gl.bindBuffer(gl.ARRAY_BUFFER, gl.createBuffer());
   gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(pt), gl.STATIC_DRAW);
   gl.vertexAttribPointer(posLoc, 2, gl.FLOAT, false, 0, 0);

   timer = setInterval(fr, 500);
   time = new Date().getTime();
//   drawScene();
   anim();

  canvas.resize = function (){
    h = window.innerHeight - 10;
    w = window.innerWidth*.85;
    canvas.width =  w;   canvas.height = h;
    gl.viewport(0, 0, w, h);
    gl.uniform2f( gl.getUniformLocation(prog, "dx"), 2/w, h );
    drawScene();
  }
}
function anim(){
   drawScene();
   requestAnimationFrame(anim);
}
function drawScene(){
  gl.uniform1f(tLoc, ti);
  gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
  ti += .002;
  frames++;
}
function fr(){
  var ti = new Date().getTime();
  var fps = Math.round(1000*frames/(ti - time));
  document.getElementById("framerate").value = fps;
  frames = 0;  time = ti;
}
</script> 
</head>
<body onload="webGLStart();" onresize="canvas.resize();"> 


<canvas id="canvas" width="800" height="300"></canvas> 
<br>fps<input size="2" id="framerate">

<br><img width="15%" height="auto" alt="cloud" src="fig/cloud10.gif"
 style="float: left; padding: 0 10 0 0px">



</body></html>
